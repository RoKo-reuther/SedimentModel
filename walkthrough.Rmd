---
title: "Model Walkthrough"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r get_code, include=FALSE, cache=FALSE}
# read in whole model code as chunks, that can be called by name
knitr::read_chunk('pure_code.R')
```

```{r initial_setup, echo=FALSE, include=FALSE}
<<libraries>>
library(plotly)
library(shinyAce)

<<preparations>>
reac_vals <- reactiveValues()

<<set-configs>>
initial_configs <- configs # default configs are named in static text
# create temporary configuration files as copy of standard files
file.copy(from = configs$parameters_config, to = "parameters_config_temp.R", overwrite = TRUE)
file.copy(from = configs$chemical_base_config, to = "chemical_base_config_temp.R", overwrite = TRUE)
file.copy(from = configs$boundary_conditions_config, to = "boundary_conditions_config_temp.R", overwrite = TRUE)

# set links to temporary configuration files
configs <- list(
  parameters_config = "parameters_config_temp.R",
  chemical_base_config = "chemical_base_config_temp.R",
  boundary_conditions_config = "boundary_conditions_config_temp.R"
)
# config files: use numbers to indicate changing, because filename always stays the same
reac_vals$config_parms <- 1
reac_vals$config_chem  <- 1
reac_vals$config_bound <- 1

<<annual-cycle>>
<<source-parameters-func>>
parameters <- parameters_bak <- reac_vals$parameters <- handlers$parmslist()

<<chemical-lists-func>>
chemical_lists <- reac_vals$chemical_lists <- handlers$chemical_base_main()

<<interactive-diagram-func>>
<<grid-setup-func>>
grid_collection <- reac_vals$grid_collection <- handlers$grid_setup()

<<boundary-conditions-func>>
boundary_conditions <- reac_vals$boundary_conditions <- handlers$get_boundaries()

<<model-preparation-func>>
<<model-function>>
<<ss2trans-func>>
<<trans-data-processing-func>>
<<plots>>
```

```{r dynamic_behavior, echo=FALSE}
# observe parameters config
observeEvent(reac_vals$config_parms, {
  parameters <<- parameters_bak <<- reac_vals$parameters <- handlers$parmslist()
  })

# observe parameters
observeEvent(reac_vals$parameters, {
  update_parms_display()
  grid_collection <<- reac_vals$grid_collection <- handlers$grid_setup()
  })

# observe boundaries config
observeEvent(reac_vals$config_bound, {
  boundary_conditions <<- reac_vals$boundary_conditions <- handlers$get_boundaries()
  })

# observe chemical config
observeEvent(reac_vals$config_chem, {
  chemical_lists <- reac_vals$chemical_lists <- handlers$chemical_base_main()
  })

# observe occurring_species
observeEvent(reac_vals$chemical_lists$occurring_species, {
  grid_collection <<- reac_vals$grid_collection <- handlers$grid_setup()
  })
```

```{r downloadDialog, echo=FALSE}
downloadDialog <- function(objectname) {
   showModal(modalDialog(size="s",
     div(style="",
        span(
          selectInput("selection", "Select object to download",
                      choices = c("boundary_conditions", "ss", "trans", "trans.df"),
                      selected = objectname)
          ),
        div(style="margin-bottom:10px; color:red",
          renderText(if(!exists(input$selection)) "This object does not exist!")
          ),
        span(style="display:flex; justify-content:center;",
          downloadHandler(
              filename = function() {
                paste(input$selection, Sys.Date(), ".rda", sep="")
              },
              content = function(file) {
                data <- get(input$selection)
                save(data, file=file)
              }
          ),
          span(style="width:25%;"),
          
          modalButton("Dismiss", icon = icon("window-close")) 
        )
     ),
     footer = NULL
  ))
}
```

This one-dimensional advective-dispersion-reactive transport model was originally written by Wytze Lenstra, Matthias Egger, Jurjen Rooze, Iana Tsandev and Caroline Slomp and later modified by Reinier Groeneveld. This version contains further modifications regarding the structure, the use of temperature dependent reaction rates and the implementation of phosphate adsorption (Langmuir approach). This document gives explanations on the model handling as well as a interface to run it.

## Setup

### Configuration Files
There are three configuration files in the project folder.
`r paste("\n-\t", paste(initial_configs, collapse = "\n-\t"), "\n", sep="")`

As the names imply, these files allow you to adjust all parameters, the chemical setup and the boundary conditions. These files are used by default, if no other configuration files are selected here.
You can also modify the configuration files using an editor. This modifications **will not affect your local configuration files**, but you can copy the modified version from the editor.

```{r custom_config, echo=FALSE}
# other configuration files can be selected and edited

div(style="display:flex; justify-content:center;",
    div(style="width:30%; border:2px solid #c5c5c5; border-radius:5px; padding:15px; padding-bottom:0px;",
      tags$style("#openEditor_p {position: relative; top:-20px;}"),
      fileInput("file_parms", label = "parameters", placeholder = "parameters", width="100%"),
      actionButton("openEditor_p", "open config file in editor", width="100%")
    ),
    div(style="width:30%; border:2px solid #c5c5c5; border-radius:5px; padding:15px; padding-bottom:0px; margin:0px 5% 0px 5%;",
       tags$style("#openEditor_c {position: relative; top:-20px;}"),
       fileInput("file_chem", label = "reactions and species", placeholder = "chemical base", width="100%"),
       actionButton("openEditor_c", "open config file in editor", width="100%")
    ),
    div(style="width:30%; border:2px solid #c5c5c5; border-radius:5px; padding:15px; padding-bottom:0px;",
       tags$style("#openEditor_b {position: relative; top:-20px;}"),
       fileInput("file_boundary", label = "boundary conditions", placeholder = "boundary conditions", width="100%"),
       actionButton("openEditor_b", "open config file in editor", width="100%")
    )
  
)

# ... and will overwrite temporary standard configuration files
observeEvent(input$file_parms, {
  file.copy(from = input$file_parms$datapath, to = "parameters_config_temp.R", overwrite = TRUE) # overwrite config file
  reac_vals$config_parms <- reac_vals$config_parms +1 # trigger dynamic behavior
})
observeEvent(input$file_chem, {
  file.copy(from = input$file_chem$datapath, to = "chemical_base_config_temp.R", overwrite = TRUE) # overwrite config file
  reac_vals$config_chem <- reac_vals$config_chem +1 # trigger dynamic behavior
})
observeEvent(input$file_boundary, {
  file.copy(from = input$file_boundary$datapath, to = "boundary_conditions_config_temp.R", overwrite = TRUE) # overwrite config file
  reac_vals$config_bound <- reac_vals$config_bound +1 # trigger dynamic behavior
})


# observers to open CONFIGURATION EDITORS and SAVE CHANGES

# parameters
observeEvent(input$openEditor_p, {
  mytext <- readLines(configs$parameters_config)
  showModal(div(tags$style(".modal-dialog {width:80%;};"),
    modalDialog(title = "config file: parameters", size = "l", easyClose = TRUE, style = "padding:0px;",
      div(
        tags$style("#edit_parameters {margin:0px; border-radius:0px; border-width:3px 0px 3px 0px};"),
        aceEditor("edit_parameters", mytext, mode = 'r', fontSize = 14, height = 830)
        ),
      footer = div(modalButton("Dismiss"), actionButton("update_parameters_config", "Apply changes",style="border-width:2px; border-color:#82a4cf;"))
      )
    ))
  })

observeEvent(input$update_parameters_config, {
  writeLines(input$edit_parameters, "parameters_config_temp.R")
  reac_vals$config_parms <- reac_vals$config_parms +1 # trigger dynamic behavior
  removeModal()
})

# boundary conditions
observeEvent(input$openEditor_b, {
  mytext <- readLines(configs$boundary_conditions_config)
  showModal(div(tags$style(".modal-dialog {width:80%;};"),
    modalDialog(title = "config file: boundary conditions", size = "l", easyClose = TRUE, style = "padding:0px;",
      div(
        tags$style("#edit_boundaries {margin:0px; border-radius:0px; border-width:3px 0px 3px 0px};"),
        aceEditor("edit_boundaries", mytext, mode = 'r', fontSize = 14, height = 830)
        ),
      footer = div(modalButton("Dismiss"), actionButton("update_boundary_config", "Apply changes",style="border-width:2px; border-color:#82a4cf;"))
      )
    ))
  })

observeEvent(input$update_boundary_config, {
  writeLines(input$edit_boundaries, "boundary_conditions_config_temp.R")
  reac_vals$config_bound <- reac_vals$config_bound +1 # trigger dynamic behavior
  removeModal()
})

# chemical config
observeEvent(input$openEditor_c, {
  mytext <- readLines(configs$chemical_base_config)
  showModal(div(tags$style(".modal-dialog {width:80%;};"),
    modalDialog(title = "config file: chemical base", size = "l", easyClose = TRUE, style = "padding:0px;",
      div(
        tags$style("#edit_chembase {margin:0px; border-radius:0px; border-width:3px 0px 3px 0px;};"),
        aceEditor("edit_chembase", mytext, mode = 'r', fontSize = 14, height = 830)
        ),
      footer = div(modalButton("Dismiss"), actionButton("update_chemical_config", "Apply changes",style="border-width:2px; border-color:#82a4cf;"))
      )
    ))
  })

observeEvent(input$update_chemical_config, {
  writeLines(input$edit_chembase, "chemical_base_config_temp.R")
  reac_vals$config_chem <- reac_vals$config_chem +1 # trigger dynamic behavior
  removeModal()
})
```

### Parameters

In the following a selection of the parameters defined in the selected "parameters configuration file" are listed in categories. Press "update parameters" to apply your changes.

```{r parameters, echo=FALSE}
# interface to change parameters
fluidPage(
  sidebarLayout(
    sidebarPanel(
      actionButton("update_parms", "update parameters", width = "100%"),
      br(),
      br(),
      actionButton("reset_parms", "restore default", width = "100%"),
      width = 3
    ),
    mainPanel(
      tabsetPanel(
        tabPanel(title="grid domain",
          fluidRow(
            column(5, numericInput("p_L", label = h5("sediment depth (m)"), value = parameters$L, min=0, step=0.05)),
            column(5, numericInput("p_N", label = h5("number of grid layers"), value = parameters$N, min=0, step=10))
          )
         ),
        tabPanel(title="sediment characteristics",
          fluidRow(
            column(5, numericInput("p_por.0", label = h5("porosity at SWI (-)"), value = parameters$por.0, min=0, step=0.05)),
            column(5, numericInput("p_por.inf", label = h5("porosity at infinite depth (-)"), value = parameters$por.inf, min=0, step=0.05))
          ),
          fluidRow(
            column(5, numericInput("p_Db", label = h5("bioturbation coefficient", "(", HTML("<sup>m²</sup>&frasl;<sub>a</sub>"), ")"), value = parameters$Db, min=0, step=0.005)),
            column(5, numericInput("p_Db_depth", label = h5("middle of Db decreasing zone (m)"), value = parameters$Db_depth, min=0, step=0.01))
          ),
          fluidRow(
            column(5, numericInput("p_v", label = h5("sedimentation rate", "(", HTML("<sup>m</sup>&frasl;<sub>yr</sub>"), ")"), value = parameters$v, min=0, step=0.05)) 
          )
        ),
        tabPanel(title="stoichiometric relationships",
          fluidRow(
            column(5, numericInput("p_CtoN", label = h5("C to N ratio in OM"), value = parameters$CtoN, min=0, step=0.05)),
            column(5, numericInput("p_CtoP", label = h5("C to P ratio in OM"), value = parameters$CtoP, min=0, step=0.05))
          )
         )
      )
    ),
    position ="right"
  )
)

observeEvent(input$update_parms, {
  update_parms_list()
    })

observeEvent(input$reset_parms, {
  parameters <<- parameters_bak
  reac_vals$parameters <- parameters
})

update_parms_list <- function(){
  parameters$L <<- input$p_L
  parameters$N <<- input$p_N
  parameters$por.0 <<- input$p_por.0
  parameters$por.inf <<- input$p_por.inf
  parameters$Db <<- input$p_Db
  parameters$Db_depth <<- input$p_Db_depth
  parameters$v <<- input$p_v
  parameters$CtoN <<- input$p_CtoN
  parameters$CtoP <<- input$p_CtoP
  reac_vals$parameters <- parameters
}

update_parms_display <- function(){
  updateNumericInput(inputId="p_L", value = parameters$L)
  updateNumericInput(inputId="p_N", value = parameters$N)
  updateNumericInput(inputId="p_por.0", value = parameters$por.0)
  updateNumericInput(inputId="p_por.inf", value = parameters$por.inf)
  updateNumericInput(inputId="p_Db", value = parameters$Db)
  updateNumericInput(inputId="p_Db_depth", value = parameters$Db_depth)
  updateNumericInput(inputId="p_v", value = parameters$v)
  updateNumericInput(inputId="p_CtoN", value = parameters$CtoN)
  updateNumericInput(inputId="p_CtoP", value = parameters$CtoP) 
}
```

```{r grid_plots, echo=FALSE}
fluidRow(
            column(6, renderPlot({plot(reac_vals$grid_collection$por.grid, grid = reac_vals$grid_collection$grid, xyswap = TRUE, type="l", xlab = "porosity (-)", ylab = "depth (m)")})),
            column(6, renderPlot({plot(reac_vals$grid_collection$Db.grid, grid = reac_vals$grid_collection$grid, xyswap = TRUE, type="l", xlab = "bioturbation coefficient (m²/a)", ylab = "depth (m)")}))
          )
```

### Reactions
#### complete list of implemented reactions

```{r reactions_table, echo=FALSE}
DT::renderDataTable({
  reaction_table_temp <- data.frame()
  for (i in reac_vals$chemical_lists$reactions_collection){

    if (exists("subsp_def", i)){
      subsp = toString(i$subsp_def)
    } else {
      subsp = "/"
    }

    reaction_table_temp <- rbind(reaction_table_temp, data.frame(
      abbreviation=i$abbreviation,
      name=i$name,
      rate_name=names(i$reaction_rates$equations),
      rate_equation=as.character(i$reaction_rates$equations),
      differing_for=subsp
      ))
  }
  reaction_table_temp
}, rownames=FALSE, colnames=c("abbr.", "reaction name", "rate name", "rate equation", "differing for"))
```

#### reactions selection & conceptual diagram

```{r reaction_handling, echo=FALSE}
## checkboxGroup
  # list of reactions without "duplicates" for checkboxGroup -> only main reactions can be selected
  reaction_table_selec <- reactive({
    temp <- data.frame()
    for (i in reac_vals$chemical_lists$reactions_collection){
      temp <- rbind(temp, data.frame(abbreviation=i$abbreviation, name=i$name, status=i$activated))
    }
    temp})

  # activated reactions
  activated_reacs <- reactive(as.vector(reaction_table_selec()[reaction_table_selec()[, "status"]==TRUE, "abbreviation"]))

  # dynamic checkbox object
  reaction_checkbox <- reactive(checkboxGroupInput("reactions_selection", label = NULL,
                     choiceNames = as.list(reaction_table_selec())$name,
                     choiceValues = as.list(reaction_table_selec())$abbreviation,
                     selected = activated_reacs(),
                     width = "90%", inline=FALSE))

## interface: reaction checkboxes, update-reactions button and diagram
fluidRow(
column(9, wellPanel(style = "overflow-y:scroll; max-height: 200px",
            renderUI(reaction_checkbox()))),
column(3, br(),
       actionButton("select_reactions", "update reactions", width="100%"),
       br(), br(),
       actionButton("de_sel_reacs", "(de)select all reactions", width ="100%"),
       br(), br(),
       actionButton("reset_reacs", "restore default", width = "100%"))
)
# wellPanel(renderVisNetwork({reac_vals$model_diagram}), style="height: 900px; padding: 0px; background-color: white; border-color: white")
wellPanel(renderVisNetwork({handlers$create_diagram(reactions_data = reac_vals$chemical_lists$occurring_reactions) %>%
                            visOptions(.,
                             width = "100%", height = 850,
                             highlightNearest = list(enabled = TRUE, degree = list(from = 2, to = 2), algorithm = "hierarchical"),
                             selectedBy = list(variable = "name", highlight = TRUE, sort = FALSE), clickToUse = FALSE)}),
          style="height: 900px; padding: 0px; background-color: white; border-color: white")

## "update reactions" button
observeEvent(input$select_reactions, {
    # update "occurring_reactions and "occurring_species"-lists; selected reactions are input
    # if no reaction is selected -> error message
    tryCatch({
      if(is.null(input$reactions_selection)) stop("Please select at least one reaction.")
      chemical_lists <<- reac_vals$chemical_lists <- handlers$chemical_base_main(specify=TRUE, as.list({input$reactions_selection}))
    },
    error = function(e) {
    showModal(modalDialog(title = "ERROR: Changes not applied",
      div(style="color:red;", e$message)
    ))
  })
})

## "(de)select all reactions" button
observeEvent(input$de_sel_reacs, {
    if ((input$de_sel_reacs %%2) != 0){
      updateCheckboxGroupInput(inputId = "reactions_selection", selected = FALSE)
    }
    else {
      updateCheckboxGroupInput(inputId = "reactions_selection", selected = as.vector(reaction_table_selec()[, "abbreviation"]))
    }
  })

## "restore defaults" button
observeEvent(input$reset_reacs, {
      updateCheckboxGroupInput(inputId = "reactions_selection", selected = activated_reacs())
  })
```

### Boundary Conditions

```{r boundary conditions UI, echo=FALSE}
# overview panel
renderUI(
  div(
    lapply(reac_vals$chemical_lists$species_operational, FUN = function(species) {
      div(
        fluidRow(
          column(2, actionButton(inputId = paste("boundary_", species$name, sep=""), label = species$name, width = "100%", style="position:relative; top:1px; border-width:medium")),
          column(1, div("up:", style="font-size:16px; position:relative; right:-40px; top:7px")),
          column(4, renderPrint(ifelse(is.null(reac_vals$boundary_conditions[[species$name]]$up), "zero gradient", reac_vals$boundary_conditions[[species$name]]$up))),
          column(1, div("down:", style="font-size:16px; position:relative; right:-20px; top:7px")),
          column(4, renderPrint(ifelse(is.null(reac_vals$boundary_conditions[[species$name]]$down), "zero gradient", reac_vals$boundary_conditions[[species$name]]$down)))
        ),
        br()
      )
    }),
    style="overflow-y:scroll; max-height: 700px;"
  )
)

# menu / boundary dialogs
# list of boundary observers; needed to destroy them every time "species_operational"-list gets updated; otherwise you will end up with redundant observers
boundary_obs <- list()

bindEvent(observe(reac_vals$chemical_lists$species_operational), {
  lapply(boundary_obs, function(x) x$destroy())        
  lapply({reac_vals$chemical_lists$species_operational}, FUN= function(species) {
    observeEvent({eval(parse(text=paste("input$boundary_", species$name, sep="")))}, {
                 
                  reac_vals$boundary_to_modify <- species$name
                  
                  reac_vals$boundary_up <- reac_vals$boundary_conditions[[species$name]]$up
                  boundary_up_type <- ifelse(is.null(reac_vals$boundary_up), "zg", ifelse(is.numeric(reac_vals$boundary_up), "v",
                                                                                          ifelse(exists("csv.file", environment(reac_vals$boundary_up)), "ac", "cf")))
                  reac_vals$boundary_down <- reac_vals$boundary_conditions[[species$name]]$down
                  boundary_down_type <- ifelse(is.null(reac_vals$boundary_down), "zg", ifelse(is.numeric(reac_vals$boundary_down), "v",
                                                                                          ifelse(exists("csv.file", environment(reac_vals$boundary_down)), "ac", "cf")))
                  reac_vals$ac_preview_up <- FALSE
                  reac_vals$ac_preview_down <- FALSE
                  
                  showModal(
                    modalDialog(title=paste("Boundary Conditions", species$name), size="m", {
                        div(style="height:440px;", tabsetPanel(type="pills",
                          # tab "up"
                          tabPanel(title="up",
                            # boundary type selection
                            column(4, style="height:415px; display: flex; align-items: center;", div(
                                radioButtons(inputId = "selec1_up", label=NULL, selected = ifelse(boundary_up_type == "zg", "zg", "sv"),
                                  choiceNames = c("zero gradient", " set concentration/flux"),
                                  choiceValues = c("zg", "sv")
                                  ),
                                conditionalPanel("input.selec1_up == 'sv'",
                                  div(style="position:relative; top:0px; left:17px",
                                      radioButtons(inputId = "selec2_up", label=NULL,
                                                   selected = ifelse(boundary_up_type != "zg", boundary_up_type, "v"),
                                         choiceNames = c("value", "annual cycle", "custom function"),
                                         choiceValues = c("v", "ac", "cf")))
                                  )
                                )
                              ),
                            # boundary specification
                            column(8, style="height:400px; display: flex; align-items: center;", div(style="width:100%",
                                conditionalPanel("input.selec1_up == 'sv'",
                                     # numeric value
                                     conditionalPanel("input.selec2_up == 'v'",
                                            renderUI(
                                              if (boundary_up_type == "v") {
                                                textInput("bound_up_v", label=NULL, placeholder=reac_vals$boundary_up, width="100%")}
                                              else {
                                                textInput("bound_up_v", label=NULL, placeholder="enter value", width="100%")}
                                              )),
                                     # "annual cycle function
                                     conditionalPanel("input.selec2_up == 'ac'", style="position:relative; top:13px;",
                                            renderUI(
                                              if (boundary_up_type == "ac") {
                                                fileInput("bound_up_ac", label=NULL, placeholder=environment(reac_vals$boundary_up)$csv.file, width="100%")}
                                              else {
                                                fileInput("bound_up_ac", label=NULL, placeholder="select csv file for annual_cycle()", width="100%")}
                                              ),
                                            renderUI(
                                              if(reac_vals$ac_preview_up == "fail") {
                                                div(renderText("something went wrong ..."))}
                                              else if(reac_vals$ac_preview_up == "success") {
                                                div(renderPlot(height = 320, plot(reac_vals$boundary_ac_preview_up, xlab="time (one year)", ylab="")), style="position:relative; top:-15px")}
                                              else if(boundary_up_type == "ac") {
                                                div(renderPlot(height = 320, plot(reac_vals$boundary_up, xlab="time (one year)", ylab="")), style="position:relative; top:-15px")}
                                              )),
                                     # custom function
                                     conditionalPanel("input.selec2_up == 'cf'", style="position:relative; top:4px;",
                                            renderUI(
                                              if (boundary_up_type == "cf") {
                                                aceEditor("bound_up_cf", mode = 'r', paste(deparse(reac_vals$boundary_up), sep="\n"), height=370)}
                                              else {
                                                aceEditor("bound_up_cf", mode = 'r', paste("function(t) {", "", "}", sep="\n"), height=370)}
                                              ))
                                     )
                                )
                              )
                            ),
                          # tab "down"                                     
                          tabPanel(title="down",
                            # boundary type selection
                            column(4, style="height:415px; display: flex; align-items: center;", div(
                                radioButtons(inputId = "selec1_down", label=NULL, selected = ifelse(boundary_down_type == "zg", "zg", "sv"),
                                  choiceNames = c("zero gradient", " set concentration/flux"),
                                  choiceValues = c("zg", "sv")
                                  ),
                                conditionalPanel("input.selec1_down == 'sv'",
                                  div(style="position:relative; top:0px; left:17px",
                                      radioButtons(inputId = "selec2_down", label=NULL,
                                                   selected = ifelse(boundary_down_type != "zg", boundary_down_type, "v"),
                                         choiceNames = c("value", "annual cycle", "custom function"),
                                         choiceValues = c("v", "ac", "cf")))
                                  )
                                )
                              ),
                            # boundary specification
                            column(8, style="height:400px; display: flex; align-items: center;", div(style="width:100%",
                                conditionalPanel("input.selec1_down == 'sv'",
                                     # numeric value
                                     conditionalPanel("input.selec2_down == 'v'",
                                            renderUI(
                                              if (boundary_down_type == "v") {
                                                textInput("bound_down_v", label=NULL, placeholder=reac_vals$boundary_down, width="100%")}
                                              else {
                                                textInput("bound_down_v", label=NULL, placeholder="enter value", width="100%")}
                                              )),
                                     # "annual cycle function
                                     conditionalPanel("input.selec2_down == 'ac'", style="position:relative; top:13px;",
                                            renderUI(
                                              if (boundary_down_type == "ac") {
                                                fileInput("bound_down_ac", label=NULL, placeholder=environment(reac_vals$boundary_down)$csv.file, width="100%")}
                                              else {
                                                fileInput("bound_down_ac", label=NULL, placeholder="select csv file for annual_cycle()", width="100%")}
                                              ),
                                            renderUI(
                                              if(reac_vals$ac_preview_down == "fail") {
                                                div(renderText("something went wrong ..."))}
                                              else if(reac_vals$ac_preview_down == "success") {
                                                div(renderPlot(height = 320, plot(reac_vals$boundary_ac_preview_down, xlab="time (one year)", ylab="")), style="position:relative; top:-15px")}
                                              else if(boundary_down_type == "ac") {
                                                div(renderPlot(height = 320, plot(reac_vals$boundary_down, xlab="time (one year)", ylab="")), style="position:relative; top:-15px")}
                                              )),
                                     # custom function
                                     conditionalPanel("input.selec2_down == 'cf'", style="position:relative; top:4px;",
                                            renderUI(
                                              if (boundary_down_type == "cf") {
                                                aceEditor("bound_down_cf", mode = 'r', paste(deparse(reac_vals$boundary_down), sep="\n"), height=370)}
                                              else {
                                                aceEditor("bound_down_cf", mode = 'r', paste("function(t) {", "", "}", sep="\n"), height=370)}
                                              ))
                                     )
                                )
                              )
                            )
                          )
                        )
                      }, footer = div(modalButton("Dismiss"), actionButton("apply_boundaries", "Apply changes",style="border-width:2px; border-color:#82a4cf;"))
                    )
                  )
      }, ignoreInit = TRUE)
    })
  })

# load csv observer: up
observeEvent(input$bound_up_ac, {
  tryCatch(expr = {
    datapath <- input$bound_up_ac$datapath
    reac_vals$boundary_ac_preview_up <- handlers$annual_cycle(csv.file = datapath)
    reac_vals$ac_preview_up <- "success"},
    error=function(e) {reac_vals$ac_preview_up <- "fail"}
    )
  })

# load csv observer: down
observeEvent(input$bound_down_ac, {
  tryCatch(expr = {
    datapath <- input$bound_down_ac$datapath
    reac_vals$boundary_ac_preview_down <- handlers$annual_cycle(csv.file = datapath)
    reac_vals$ac_preview_down <- "success"},
    error=function(e) {reac_vals$ac_preview_down <- "fail"}
    )
  })

# apply boundary changes
observeEvent(input$apply_boundaries, {
  tryCatch(expr = {
    # up:
    if (input$selec1_up == "zg") {
      reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$up <- NULL
    }
    else if (input$selec2_up == "v" && input$bound_up_v != "") {
      if(is.na(as.numeric(input$bound_up_v))) {stop("Value for upstream boundary is not numeric.")}
      reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$up <- as.numeric(input$bound_up_v)
    }
    else if (input$selec2_up == "ac" && !is.null(input$bound_up_ac)) {
      datapath <- input$bound_up_ac$datapath
      reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$up <- handlers$annual_cycle(csv.file = datapath)
    }
    else if (input$selec2_up == "cf" && input$bound_up_cf != "function(t) {\n\n}") {
      reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$up <- eval(parse(text=input$bound_up_cf))
    }
    
    # down:
    if (input$selec1_down == "zg") {
      reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$down <- NULL
    }
    else if (input$selec2_down == "v"&& input$bound_down_v != "") {
      if(is.na(as.numeric(input$bound_down_v))) {stop("Value for downstream boundary is not numeric.")}
      reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$down <- as.numeric(input$bound_down_v)
    }
    else if (input$selec2_down == "ac" && !is.null(input$bound_down_ac)) {
      datapath <- input$bound_down_ac$datapath
      reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$down <- handlers$annual_cycle(csv.file = datapath)
    }
    else if (input$selec2_down == "cf"&& input$bound_down_cf != "function(t) {\n\n}") {
      reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$down <- eval(parse(text=input$bound_down_cf))
    }
    
    # update boundary_conditions list and close dialog
    boundary_conditions <<- reac_vals$boundary_conditions
    removeModal()
  },
  error = function(e) {
    showModal(modalDialog(title = "ERROR: Changes not applied",
      div(style="color:red;", e$message)
    ))
  })
})
```

## Run Model

### Steady-state
```{r steady_state, echo=FALSE}
ss_expr <- ss_expr_bak <- knitr::knit_code$get('steady-state-solving') # steady state solver call; stored in variable to make it possibly editable

# buttons
div(style="display:flex; justify-content:left;",
 actionButton("steady_state", "solve steady state"),
 div(style="width:5%;"),
 actionButton("openEditor_ss", "edit solver call"),
 div(style="width:5%;"),
 renderUI(if (reac_vals$show_ss_plots == 1) {actionButton("download_ss", "download results")}) 
)

# button observers
observeEvent(input$steady_state, {
 withProgress(message = 'Solving model ...', min=0, max=0, {
   tryCatch({
    model_lists <<- reac_vals$model_lists <- handlers$create_model_lists()
    eval(parse(text=ss_expr))
    ss <<- reac_vals$ss <- ss
    reac_vals$show_ss_plots <- 1
    trans_input_selec <<- "ss_res" # use this results for transient solving
   },
   error = function(e) {
     reac_vals$show_ss_plots <- 2
     reac_vals$ss_prints <- e$message
     },
   warning = function(w) {
     reac_vals$show_ss_plots <- 2
     reac_vals$ss_prints <- w$message
   }
  )
 })
})

observeEvent(input$openEditor_ss, {
  showModal(
    modalDialog(title = "Steady-state solver call", size = "m", easyClose = TRUE, style = "padding:0px;",
      div(
        tags$style("#edit_ss_expr {margin:0px; border-radius:0px; border-width:3px 0px 3px 0px};"),
        aceEditor("edit_ss_expr", ss_expr, mode = 'r', fontSize = 14, height = 400)
        ),
      footer = div(modalButton("Dismiss"),
                   actionButton("restore_ss_expr", "Restore default"),
                   actionButton("update_ss_expr", "Apply changes",style="border-width:2px; border-color:#82a4cf;")
                   )
      )
    )
})

observeEvent(input$update_ss_expr, {
  ss_expr <<- input$edit_ss_expr
  removeModal()
})

observeEvent(input$restore_ss_expr, {
  ss_expr <<- ss_expr_bak
  removeModal()
})

observeEvent(input$download_ss, {
  downloadDialog("ss")
})

# model output plots / error messages
reac_vals$show_ss_plots <- 0 # 0 -> model not solved yet -> nothing to display

ss_conc_selection <- reactive(stringr::str_split(input$ss_plot_collective_cp, ", ", simplify = TRUE))
ss_concentration_profiles_selec <- reactive(handlers$concentration_profiles_ss(ss_data=reac_vals$ss, draw_mode = "collective", species = ss_conc_selection(), v_correction=input$ss_v_correction))
ss_concentration_profiles <- reactive(handlers$concentration_profiles_ss(ss_data=reac_vals$ss, v_correction=input$ss_v_correction))

ss_rate_selection <- reactive(stringr::str_split(input$ss_plot_collective_rr, ", ", simplify = TRUE))
ss_rate_profiles_selec <- reactive(handlers$rate_profiles_ss(ss_data=reac_vals$ss, draw_mode = "collective", rates = ss_rate_selection()))
ss_rate_profiles <- reactive(handlers$rate_profiles_ss(ss_data=reac_vals$ss))

renderUI(
if (reac_vals$show_ss_plots == 1) {
  tabsetPanel(
    tabPanel(title="concentration profiles",
      div(
        br(),
        checkboxInput("ss_v_correction", "correction for volume phases", value=TRUE),
        textInput("ss_plot_collective_cp", label="Enter species names to be plotted together", value = "OrgCA, OrgCB, OrgCC", width = "100%"),
        renderPlotly(ggplotly(ss_concentration_profiles_selec() + theme(legend.text = element_text(size = 11), legend.key.size = unit(0.8, "cm"))+ scale_color_discrete(name = NULL))),
        br(),
        renderPlot(ss_concentration_profiles(), height = function() {225*ceiling(length(attributes(reac_vals$ss$y)$dimnames[[2]])/4)}),
        style="overflow-y:scroll; max-height: 950px")
    ),
    tabPanel(title="reaction rate profiles",
      div(
        br(),
        textInput("ss_plot_collective_rr", label="Enter rate names to be plotted together", value = "R1_a, RN_a, RM_aa, R2_Ox_aa, R3_a, R4_a", width = "100%"),
        renderPlotly(ggplotly(ss_rate_profiles_selec() + theme(legend.text = element_text(size = 11), legend.key.size = unit(0.8, "cm")) + scale_color_discrete(name = NULL))),
        br(),
        renderPlot(ss_rate_profiles(), height = function() {225*ceiling(length(reac_vals$ss$reaction_rates)/4)}),
        style="overflow-y:scroll; max-height: 950px")
    ),
    tabPanel(title="combined profiles",
      div(
        br(),
        lapply(names(reac_vals$chemical_lists$species_operational), function(x) renderPlotly(ggplotly(handlers$combined_profiles_ss(ss_data=reac_vals$ss, species=x)))),
        style="overflow-y:scroll; max-height: 950px")
    ),
    tabPanel(title="model function content",
        div(id = "corny", style="overflow-y:scroll; max-height: 950px;",
          tags$style("#corny .shiny-text-output {border:0px; overflow-x:hidden; background-color:white;}"),
          renderPrint(cat(reac_vals$model_lists$t_combined_expression)),
        )
    )
  )
} else if (reac_vals$show_ss_plots == 2) {
    div(style="color:red", reac_vals$ss_prints)
})
```

### Transient scenario
```{r transient, echo=FALSE}
trans_expr <- trans_expr_bak <- knitr::knit_code$get('transient-solving') # transient solver call; stored in variable to make it possibly editable
# input vector for transient solving
trans_input_selec <- "zeros" # initially a vector of 0's is used
# it will be changed when steady state was calculated: trans_input_selec <- "ss_res"
# it also can be changed manually in the "select transient input"-dialog

# buttons
div(style="display:flex; justify-content:left;",
 actionButton("trans_input_selec", "select transient input"),
 div(style="width:5%;"),
 actionButton("transient", "solve transient scenario"),
 div(style="width:5%;"),
 actionButton("openEditor_trans", "edit solver call"),
 div(style="width:5%;"),
 renderUI(if (reac_vals$show_trans_plots == 1) {actionButton("download_trans", "download results")}) 
)

# button observers
observeEvent(input$trans_input_selec, {
  showModal(
    modalDialog(title="Select initial values for transient solving", size="m", {
        div(style="height:200px;",
            column(4, style="height:200px; display: flex; align-items: center;",
                renderUI(
                  if (exists('ss')) {
                    radioButtons(inputId = "selec_trans_in", label=NULL, selected = trans_input_selec,
                      choiceNames = c("zeros", "steady state results", "custom"),
                      choiceValues = c("zeros", "ss_res", "custom")
                    )}
                  else {
                    radioButtons(inputId = "selec_trans_in", label=NULL, selected = trans_input_selec,
                      choiceNames = c("zeros", "custom"),
                      choiceValues = c("zeros", "custom")
                    )}
                )
              ),
            column(8, style="height:180px; display: flex; align-items: center;",
                   div(style="width:100%",
                       conditionalPanel("input.selec_trans_in == 'zeros'",
                                        renderText("Creates a vector of appropriate length filled with 0.")
                                        ),
                       conditionalPanel("input.selec_trans_in == 'ss_res'",
                                        renderText("Takes the steady-state results as input vector.")
                                        ),
                       conditionalPanel("input.selec_trans_in == 'custom'",
                                        renderText(paste("The result has has to be a vector of length ", parameters$N*length(chemical_lists$species_operational), ".", sep="")),
                                        aceEditor("trans_input_custom", mode = 'r', height=160)
                                        )
                       )
                   )
            )
    }, footer = div(modalButton("Dismiss"), actionButton("apply_trans_input", "Apply",style="border-width:2px; border-color:#82a4cf;")))
  )
})

observeEvent(input$apply_trans_input, {
  if (input$selec_trans_in == "zeros")       trans_input_selec <<- "zeros"
  else if (input$selec_trans_in == "ss_res") trans_input_selec <<- "ss_res"
  else if (input$selec_trans_in == "custom") trans_input_selec <<- "custom"
  removeModal()
})

observeEvent(input$transient, {
 withProgress(message = 'Solving model ...', min=0, max=0, {
   tryCatch({
    if      (trans_input_selec == "zeros")  trans_input <- rep(0, parameters$N*length(chemical_lists$species_operational))
    else if (trans_input_selec == "ss_res") trans_input <- handlers$extract_ss()
    else if (trans_input_selec == "custom") trans_input <- eval(parse(text=input$trans_input_custom)) 
    model_lists <<- reac_vals$model_lists <- handlers$create_model_lists()
    eval(parse(text=trans_expr))
    trans <<- reac_vals$trans <- trans
    trans.df <<- reac_vals$trans.df <- handlers$get_trans_df()
    reac_vals$show_trans_plots <- 1
   },
   error = function(e) {
     reac_vals$show_trans_plots <- 2
     reac_vals$trans_prints <- e$message
     },
   warning = function(w) {
     reac_vals$show_trans_plots <- 2
     reac_vals$trans_prints <- w$message
   }
  )
 })
})

observeEvent(input$openEditor_trans, {
  showModal(
    modalDialog(title = "Transient solver call", size = "m", easyClose = TRUE, style = "padding:0px;",
      div(
        tags$style("#edit_trans_expr {margin:0px; border-radius:0px; border-width:3px 0px 3px 0px};"),
        aceEditor("edit_trans_expr", trans_expr, mode = 'r', fontSize = 14, height = 400)
        ),
      footer = div(modalButton("Dismiss"),
                   actionButton("restore_trans_expr", "Restore default"),
                   actionButton("update_trans_expr", "Apply changes",style="border-width:2px; border-color:#82a4cf;")
                   )
      )
    )
})

observeEvent(input$update_trans_expr, {
  trans_expr <<- input$edit_trans_expr
  removeModal()
})

observeEvent(input$restore_trans_expr, {
  trans_expr <<- trans_expr_bak
  removeModal()
})

observeEvent(input$download_trans, {
  downloadDialog("trans")
})

# model output plots
reac_vals$show_trans_plots <- 0 # 0 -> model not solved yet -> nothing to display

trans_concentration_rasters <- reactive(handlers$concentration_rasters_trans(trans_data=reac_vals$trans.df, v_correction=input$trans_v_correction))
trans_rate_rasters <- reactive(handlers$rate_rasters_trans(trans_data=reac_vals$trans.df))

renderUI(
if (reac_vals$show_trans_plots == 1) {
  tabsetPanel(
    tabPanel(title="concentration profiles",
      div(
        br(),
        checkboxInput("trans_v_correction", "correction for volume phases", value=TRUE),
        renderPlot(trans_concentration_rasters(), height = function() {230*length(reac_vals$chemical_lists$species_operational)}),
        style="overflow-y:scroll; max-height: 950px")
    ),
    tabPanel(title="reaction rate profiles",
      div(
        br(),
        renderPlot(trans_rate_rasters(), height = function() {230*length(reac_vals$chemical_lists$reactions_operational)}),
        style="overflow-y:scroll; max-height: 950px")
    ),
    tabPanel(title="combined profiles",
      div(
        br(),
        lapply(names(reac_vals$chemical_lists$species_operational), function(x) {
          combined_plot <- handlers$combined_rasters_trans(trans_data=reac_vals$trans.df, species=x)
          return(renderPlot(combined_plot$plot, height = combined_plot$nmb_plots*230))
          }),
        style="overflow-y:scroll; max-height: 950px")
    ),
    tabPanel(title="model function content",
        div(id = "corny", style="overflow-y:scroll; max-height: 950px;",
          tags$style("#corny .shiny-text-output {border:0px; overflow-x:hidden; background-color:white;}"),
          renderPrint(cat(reac_vals$model_lists$t_combined_expression)),
        )
    )
  )
} else if (reac_vals$show_trans_plots == 2) {
    div(style="color:red", reac_vals$trans_prints)
})
```



```{r on_exit, include=FALSE}
onStop(function () {
  file.remove("parameters_config_temp.R")
  file.remove("chemical_base_config_temp.R")
  file.remove("boundary_conditions_config_temp.R")
  })
```