---
title: "Model Walkthrough"
output:
  html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r get_code, include=FALSE, cache=FALSE}
# read in whole model code as chunks, that can be called by name
knitr::read_chunk('pure_code.R')
```

```{r initial_setup, echo=FALSE, include=FALSE}
<<libraries>>
library(plotly)
library(shinyAce)
<<preparations>>
reac_vals <- reactiveValues()
<<set_configs>>
initial_configs <- configs
# create temporary configuration files as copy of standard files
file.copy(from = configs$parameters_config, to = "parameters_config_temp.R", overwrite = TRUE)
file.copy(from = configs$chemical_base_config, to = "chemical_base_config_temp.R", overwrite = TRUE)
file.copy(from = configs$boundary_conditions_config, to = "boundary_conditions_config_temp.R", overwrite = TRUE)

# set links to temporary configuration files
configs <- list(
  parameters_config = "parameters_config_temp.R",
  chemical_base_config = "chemical_base_config_temp.R",
  boundary_conditions_config = "boundary_conditions_config_temp.R"
)
# config files: use numbers to indicate changing, because filename always stays the same
reac_vals$config_parms <- 1
reac_vals$config_chem  <- 1
reac_vals$config_bound <- 1
<<source_parameters>>
parameters_bak <- parameters
reac_vals$parameters <- parameters
<<chemical_lists>>
reac_vals$occurring_reactions <- occurring_reactions
reac_vals$occurring_species <- occurring_species
reac_vals$reactions_collection <- reactions_collection
reac_vals$species_operational <- species_operational
<<grid_setup>>
reac_vals$grid_collection <- grid_collection
<<boundary_conditions>>
reac_vals$boundary_conditions <- boundary_conditions
<<model-preparation-func>>
<<model_function>>
<<plots>>
```

```{r dynamic_behavior, echo=FALSE}
# observe parameters config
observeEvent(reac_vals$config_parms, {
  <<source_parameters>>
  parameters <<- parameters
  parameters_bak <<- parameters
  reac_vals$parameters <- parameters
  })

# observe boundaries config
observeEvent(reac_vals$config_bound, {
  boundary_conditions <<- handlers$get_boundaries()
  reac_vals$boundary_conditions <- boundary_conditions
  })

# observe parameters
observeEvent(reac_vals$parameters, {
  update_parms_display()
  grid_collection <<- handlers$grid_setup()
  reac_vals$grid_collection <- grid_collection
  })

# observe chemical config
observeEvent(reac_vals$config_chem, {
  <<chemical_lists>>
  occurring_reactions <<- occurring_reactions
  occurring_species <<- occurring_species
  reactions_collection <<- reactions_collection
  species_operational <<- species_operational
  reac_vals$occurring_reactions <- occurring_reactions
  reac_vals$occurring_species <- occurring_species
  reac_vals$reactions_collection <- reactions_collection
  reac_vals$species_operational <- species_operational
  })

# observe occurring_reactions
observeEvent(reac_vals$occurring_reactions, {
  model_diagram <<- create_diagram()
  reac_vals$model_diagram <- model_diagram
  })

# observe occurring_species
observeEvent(reac_vals$occurring_species, {
  grid_collection <<- handlers$grid_setup()
  reac_vals$grid_collection <- grid_collection
  })
```

This one-dimensional advective-dispersion-reactive transport model was originally written by Wytze Lenstra, Matthias Egger, Jurjen Rooze, Iana Tsandev and Caroline Slomp and later modified by Reinier Groeneveld. This version contains further modifications regarding the structure, the use of temperature dependent reaction rates and the implementation of phosphate adsorption (Langmuir approach). This document gives explanations on the model handling as well as a interface to run it.

## Setup

### Configuration Files
There are three configuration files in the project folder.
`r paste("\n-\t", paste(initial_configs, collapse = "\n-\t"), "\n", sep="")`

As the names imply, these files allow you to adjust all parameters, the chemical setup and the boundary conditions. These files are used by default, if no other configuration files are selected here:

```{r custom_config, echo=FALSE}
# other configuration files can be selected ...
fluidPage(
  fluidRow(
    # parameters configuration
    column(4,   fileInput("file_parms", label = NULL, placeholder = "parameters"), offset = 0),
    # chemical base configuration
    column(4, fileInput("file_chem", label = NULL, placeholder = "chemical base"),  offset = 0.5),
    # boundary conditions configuration
    column(4, fileInput("file_boundary", label = NULL, placeholder = "boundary conditions"), offset = 0.5)
  )
)

# ... and will overwrite temporary standard configuration files
observeEvent(input$file_parms, {
  file.copy(from = input$file_parms$datapath, to = "parameters_config_temp.R", overwrite = TRUE) # overwrite config file
  reac_vals$config_parms <- reac_vals$config_parms +1 # trigger dynamic behavior
})
observeEvent(input$file_chem, {
  file.copy(from = input$file_chem$datapath, to = "chemical_base_config_temp.R", overwrite = TRUE) # overwrite config file
  reac_vals$config_chem <- reac_vals$config_chem +1 # trigger dynamic behavior
})
observeEvent(input$file_boundary, {
  file.copy(from = input$file_boundary$datapath, to = "boundary_conditions_config_temp.R", overwrite = TRUE) # overwrite config file
  reac_vals$config_bound <- reac_vals$config_bound +1 # trigger dynamic behavior
})
```

### Parameters

In the following a selection of the parameters defined in the selected "parameters configuration file" are listed in categories. Press "update parameters" to apply your changes.

```{r parameters, echo=FALSE}
# interface to change parameters
fluidPage(
  sidebarLayout(
    sidebarPanel(
      actionButton("update_parms", "update parameters", width = "100%"),
      br(),
      br(),
      actionButton("reset_parms", "restore default", width = "100%"),
      width = 3
    ),
    mainPanel(
      tabsetPanel(
        tabPanel(title="grid domain",
          fluidRow(
            column(5, numericInput("p_L", label = h5("sediment depth (m)"), value = parameters$L, min=0, step=0.05)),
            column(5, numericInput("p_N", label = h5("number of grid layers"), value = parameters$N, min=0, step=10))
          )
         ),
        tabPanel(title="environmental",
          fluidRow(
            column(5, numericInput("p_por.0", label = h5("porosity at SWI (-)"), value = parameters$por.0, min=0, step=0.05)),
            column(5, numericInput("p_por.inf", label = h5("porosity at infinite depth (-)"), value = parameters$por.inf, min=0, step=0.05))
          ),
          fluidRow(
            column(5, numericInput("p_Db", label = h5("bioturbation coefficient", "(", HTML("<sup>m²</sup>&frasl;<sub>a</sub>"), ")"), value = parameters$Db, min=0, step=0.005)),
            column(5, numericInput("p_Db_depth", label = h5("middle of Db decreasing zone (m)"), value = parameters$Db_depth, min=0, step=0.01))
          ),
          fluidRow(
            column(5, numericInput("p_v", label = h5("sedimentation rate", "(", HTML("<sup>m</sup>&frasl;<sub>yr</sub>"), ")"), value = parameters$v, min=0, step=0.05)) 
          )
        ),
        tabPanel(title="stoichiometric relationships",
          fluidRow(
            column(5, numericInput("p_CtoN", label = h5("C to N ratio in OM"), value = parameters$CtoN, min=0, step=0.05)),
            column(5, numericInput("p_CtoP", label = h5("C to P ratio in OM"), value = parameters$CtoP, min=0, step=0.05))
          )
         )
      )
    ),
    position ="right"
  )
)

observeEvent(input$update_parms, {
  update_parms_list()
    })

observeEvent(input$reset_parms, {
  parameters <<- parameters_bak
  reac_vals$parameters <- parameters
})

update_parms_list <- function(){
  parameters$L <<- input$p_L
  parameters$N <<- input$p_N
  parameters$por.0 <<- input$p_por.0
  parameters$por.inf <<- input$p_por.inf
  parameters$Db <<- input$p_Db
  parameters$Db_depth <<- input$p_Db_depth
  parameters$v <<- input$p_v
  parameters$CtoN <<- input$p_CtoN
  parameters$CtoP <<- input$p_CtoP
  reac_vals$parameters <- parameters
}

update_parms_display <- function(){
  updateNumericInput(inputId="p_L", value = parameters$L)
  updateNumericInput(inputId="p_N", value = parameters$N)
  updateNumericInput(inputId="p_por.0", value = parameters$por.0)
  updateNumericInput(inputId="p_por.inf", value = parameters$por.inf)
  updateNumericInput(inputId="p_Db", value = parameters$Db)
  updateNumericInput(inputId="p_Db_depth", value = parameters$Db_depth)
  updateNumericInput(inputId="p_v", value = parameters$v)
  updateNumericInput(inputId="p_CtoN", value = parameters$CtoN)
  updateNumericInput(inputId="p_CtoP", value = parameters$CtoP) 
}
```

```{r grid_plots, echo=FALSE}
fluidRow(
            column(6, renderPlot({plot(reac_vals$grid_collection$por.grid, grid = reac_vals$grid_collection$grid, xyswap = TRUE, type="l", xlab = "porosity (-)", ylab = "depth (m)")})),
            column(6, renderPlot({plot(reac_vals$grid_collection$Db.grid, grid = reac_vals$grid_collection$grid, xyswap = TRUE, type="l", xlab = "bioturbation coefficient (m²/a)", ylab = "depth (m)")}))
          )
```

### Reactions
#### complete list of implemented reactions

```{r reactions_table, echo=FALSE}
DT::renderDataTable({
  reaction_table_temp <- data.frame()
  for (i in reac_vals$reactions_collection){

    if (exists("subsp_def", i)){
      subsp = toString(i$subsp_def)
    } else {
      subsp = "/"
    }

    reaction_table_temp <- rbind(reaction_table_temp, data.frame(
      abbreviation=i$abbreviation,
      name=i$name,
      rate_name=names(i$reaction_rates$equations),
      rate_equation=as.character(i$reaction_rates$equations),
      differing_for=subsp
      ))
  }
  reaction_table_temp
}, rownames=FALSE, colnames=c("abbr.", "reaction name", "rate name", "rate equation", "differing for"))
```

#### reactions selection & conceptual diagram

```{r reaction_handling, echo=FALSE}
## checkboxGroup
  # list of reactions without "duplicates" for checkboxGroup -> only main reactions can be selected
  reaction_table_selec <- reactive({
    temp <- data.frame()
    for (i in reac_vals$reactions_collection){
      temp <- rbind(temp, data.frame(abbreviation=i$abbreviation, name=i$name, status=i$activated))
    }
    temp})

  # activated reactions
  activated_reacs <- reactive(as.vector(reaction_table_selec()[reaction_table_selec()[, "status"]==TRUE, "abbreviation"]))

  # dynamic checkbox object
  reaction_checkbox <- reactive(checkboxGroupInput("reactions_selection", label = NULL,
                     choiceNames = as.list(reaction_table_selec())$name,
                     choiceValues = as.list(reaction_table_selec())$abbreviation,
                     selected = activated_reacs(),
                     width = "90%", inline=FALSE))

## interactive diagram
  # function to create diagram
  create_diagram <- function(){
    <<interactive_diagram>>
    model_diagram <- visOptions(model_diagram,
                             width = "100%", height = 850,
                             highlightNearest = list(enabled = TRUE, degree = list(from = 2, to = 2), algorithm = "hierarchical"),
                             selectedBy = list(variable = "name", selected = "OM", highlight = TRUE, sort = FALSE), clickToUse = FALSE)
    return(model_diagram)

  }
  # create diagram
  model_diagram <- create_diagram()
  reac_vals$model_diagram <- model_diagram

## interface: reaction checkboxes, update-reactions button and diagram
fluidRow(
column(9, wellPanel(style = "overflow-y:scroll; max-height: 200px",
            renderUI(reaction_checkbox()))),
column(3, br(),
       actionButton("select_reactions", "update reactions", width="100%"),
       br(), br(),
       actionButton("de_sel_reacs", "(de)select all reactions", width ="100%"),
       br(), br(),
       actionButton("reset_reacs", "restore default", width = "100%"))
)
wellPanel(renderVisNetwork({reac_vals$model_diagram}), style="height: 900px; padding: 0px; background-color: white; border-color: white")

## "update reactions" button
observeEvent(input$select_reactions, {
    # update "occurring_reactions and "occurring_species"-lists; selected reactions are input
    # if no reaction is selected -> error message
    chemical_lists <- handlers$chemical_base_main(specify=TRUE, as.list({input$reactions_selection}))
    occurring_reactions <<- chemical_lists$oc_reactions
    occurring_species <<- chemical_lists$oc_species
    species_operational <<- chemical_lists$species_oper
    reac_vals$occurring_reactions <- occurring_reactions
    reac_vals$occurring_species <- occurring_species
    reac_vals$species_operational <- species_operational
  })

## "(de)select all reactions" button
observeEvent(input$de_sel_reacs, {
    if ((input$de_sel_reacs %%2) != 0){
      updateCheckboxGroupInput(inputId = "reactions_selection", selected = FALSE)
    }
    else {
      updateCheckboxGroupInput(inputId = "reactions_selection", selected = as.vector(reaction_table_selec()[, "abbreviation"]))
    }
  })

## "restore defaults" button
observeEvent(input$reset_reacs, {
      updateCheckboxGroupInput(inputId = "reactions_selection", selected = activated_reacs())
  })
```

### Boundary Conditions

```{r boundary conditions UI, echo=FALSE}
# overview panel
renderUI(
  div(
    lapply(reac_vals$species_operational, FUN = function(species) {
      div(
        fluidRow(
          column(2, actionButton(inputId = paste("boundary_", species$name, sep=""), label = species$name, width = "100%", style="position:relative; top:1px; border-width:medium")),
          column(1, div("up:", style="font-size:16px; position:relative; right:-40px; top:7px")),
          column(4, renderPrint(ifelse(is.null(reac_vals$boundary_conditions[[species$name]]$up), "zero gradient", reac_vals$boundary_conditions[[species$name]]$up))),
          column(1, div("down:", style="font-size:16px; position:relative; right:-20px; top:7px")),
          column(4, renderPrint(ifelse(is.null(reac_vals$boundary_conditions[[species$name]]$down), "zero gradient", reac_vals$boundary_conditions[[species$name]]$down)))
        ),
        br()
      )
    }),
    style="overflow-y:scroll; max-height: 700px;"
  )
)

# menu
observe(lapply({reac_vals$species_operational}, FUN= function(species) {
  observeEvent({eval(parse(text=paste("input$boundary_", species$name, sep="")))}, {
               
                reac_vals$boundary_to_modify <- species$name
                
                reac_vals$boundary_up <- reac_vals$boundary_conditions[[species$name]]$up
                boundary_up_type <- ifelse(is.null(reac_vals$boundary_up), "zg", ifelse(is.numeric(reac_vals$boundary_up), "v",
                                                                                        ifelse(exists("csv.file", environment(reac_vals$boundary_up)), "ac", "cf")))
                reac_vals$boundary_down <- reac_vals$boundary_conditions[[species$name]]$down
                boundary_down_type <- ifelse(is.null(reac_vals$boundary_down), "zg", ifelse(is.numeric(reac_vals$boundary_down), "v",
                                                                                        ifelse(exists("csv.file", environment(reac_vals$boundary_down)), "ac", "cf")))
                reac_vals$ac_preview_up <- FALSE
                reac_vals$ac_preview_down <- FALSE
                
                showModal(
                  modalDialog(title=paste("Boundary Conditions", species$name), size="m", {
                      div(style="height:440px;", tabsetPanel(type="pills",
                        # tab "up"
                        tabPanel(title="up",
                          # boundary type selection
                          column(4, style="height:415px; display: flex; align-items: center;", div(
                              radioButtons(inputId = "selec1_up", label=NULL, selected = ifelse(boundary_up_type == "zg", "zg", "sv"),
                                choiceNames = c("zero gradient", " set concentration/flux"),
                                choiceValues = c("zg", "sv")
                                ),
                              conditionalPanel("input.selec1_up == 'sv'",
                                div(style="position:relative; top:0px; left:17px",
                                    radioButtons(inputId = "selec2_up", label=NULL,
                                                 selected = ifelse(boundary_up_type != "zg", boundary_up_type, "v"),
                                       choiceNames = c("value", "annual cycle", "custom function"),
                                       choiceValues = c("v", "ac", "cf")))
                                )
                              )
                            ),
                          # boundary specification
                          column(8, style="border: 3px solid #82a4cf; border-radius:5px; height:400px; display: flex; align-items: center;", div(style="width:100%",
                              conditionalPanel("input.selec1_up == 'sv'",
                                   # numeric value
                                   conditionalPanel("input.selec2_up == 'v'",
                                          renderUI(
                                            if (boundary_up_type == "v") {
                                              textInput("bound_up_v", label=NULL, placeholder=reac_vals$boundary_up, width="100%")}
                                            else {
                                              textInput("bound_up_v", label=NULL, placeholder="enter value", width="100%")}
                                            )),
                                   # "annual cycle function
                                   conditionalPanel("input.selec2_up == 'ac'", style="position:relative; top:13px;",
                                          renderUI(
                                            if (boundary_up_type == "ac") {
                                              fileInput("bound_up_ac", label=NULL, placeholder=environment(reac_vals$boundary_up)$csv.file, width="100%")}
                                            else {
                                              fileInput("bound_up_ac", label=NULL, placeholder="select csv file for annual_cycle()", width="100%")}
                                            ),
                                          renderUI(
                                            if(reac_vals$ac_preview_up) {
                                              div(renderPlot(height = 320, plot(reac_vals$boundary_ac_preview, xlab="time (one year)", ylab="")), style="position:relative; top:-15px")}
                                            else if(boundary_up_type == "ac") {
                                              div(renderPlot(height = 320, plot(reac_vals$boundary_up, xlab="time (one year)", ylab="")), style="position:relative; top:-15px")}
                                            )),
                                   # custom function
                                   conditionalPanel("input.selec2_up == 'cf'", style="position:relative; top:4px;",
                                          renderUI(
                                            if (boundary_up_type == "cf") {
                                              aceEditor("bound_up_cf", paste(deparse(reac_vals$boundary_up), sep="\n"), height=370)}
                                            else {
                                              aceEditor("bound_up_cf", paste("function(t) {", "", "}", sep="\n"), height=370)}
                                            ))
                                   )
                              )
                            )
                          ),
                        # tab "down"                                     
                        tabPanel(title="down",
                          # boundary type selection
                          column(4, style="height:415px; display: flex; align-items: center;", div(
                              radioButtons(inputId = "selec1_down", label=NULL, selected = ifelse(boundary_down_type == "zg", "zg", "sv"),
                                choiceNames = c("zero gradient", " set concentration/flux"),
                                choiceValues = c("zg", "sv")
                                ),
                              conditionalPanel("input.selec1_down == 'sv'",
                                div(style="position:relative; top:0px; left:17px",
                                    radioButtons(inputId = "selec2_down", label=NULL,
                                                 selected = ifelse(boundary_down_type != "zg", boundary_down_type, "v"),
                                       choiceNames = c("value", "annual cycle", "custom function"),
                                       choiceValues = c("v", "ac", "cf")))
                                )
                              )
                            ),
                          # boundary specification
                          column(8, style="border: 3px solid #82a4cf; border-radius:5px; height:400px; display: flex; align-items: center;", div(style="width:100%",
                              conditionalPanel("input.selec1_down == 'sv'",
                                   # numeric value
                                   conditionalPanel("input.selec2_down == 'v'",
                                          renderUI(
                                            if (boundary_down_type == "v") {
                                              textInput("bound_down_v", label=NULL, placeholder=reac_vals$boundary_down, width="100%")}
                                            else {
                                              textInput("bound_down_v", label=NULL, placeholder="enter value", width="100%")}
                                            )),
                                   # "annual cycle function
                                   conditionalPanel("input.selec2_down == 'ac'", style="position:relative; top:13px;",
                                          renderUI(
                                            if (boundary_down_type == "ac") {
                                              fileInput("bound_down_ac", label=NULL, placeholder=environment(reac_vals$boundary_down)$csv.file, width="100%")}
                                            else {
                                              fileInput("bound_down_ac", label=NULL, placeholder="select csv file for annual_cycle()", width="100%")}
                                            ),
                                          renderUI(
                                            if(reac_vals$ac_preview_down) {
                                              div(renderPlot(height = 320, plot(reac_vals$boundary_ac_preview, xlab="time (one year)", ylab="")), style="position:relative; top:-15px")}
                                            else if(boundary_down_type == "ac") {
                                              div(renderPlot(height = 320, plot(reac_vals$boundary_down, xlab="time (one year)", ylab="")), style="position:relative; top:-15px")}
                                            )),
                                   # custom function
                                   conditionalPanel("input.selec2_down == 'cf'", style="position:relative; top:4px;",
                                          renderUI(
                                            if (boundary_down_type == "cf") {
                                              aceEditor("bound_down_cf", paste(deparse(reac_vals$boundary_down), sep="\n"), height=370)}
                                            else {
                                              aceEditor("bound_down_cf", paste("function(t) {", "", "}", sep="\n"), height=370)}
                                            ))
                                   )
                              )
                            )
                          )
                        )
                      )
                    }, footer = div(modalButton("Dismiss"), actionButton("apply_boundaries", "Apply changes",style="border-width:2px;"))
                  )
                )
    })
}))

# load csv observer: up
observeEvent(input$bound_up_ac, {
  datapath <- input$bound_up_ac$datapath
  reac_vals$boundary_ac_preview <- handlers$annual_cycle(csv.file = datapath)
  reac_vals$ac_preview_up <- TRUE
  })

# load csv observer: down
observeEvent(input$bound_down_ac, {
  datapath <- input$bound_down_ac$datapath
  reac_vals$boundary_ac_preview <- handlers$annual_cycle(csv.file = datapath)
  reac_vals$ac_preview_down <- TRUE
  })


# apply boundary changes
observeEvent(input$apply_boundaries, {
  # up:
  if (input$selec1_up == "zg") {
    reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$up <- NULL
  }
  else if (input$selec2_up == "v") {
    reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$up <- as.numeric(input$bound_up_v)
  }
  else if (input$selec2_up == "ac") {
    datapath <- input$bound_up_ac$datapath
    reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$up <- handlers$annual_cycle(csv.file = datapath)
  }
  else if (input$selec2_up == "cf") {
    reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$up <- eval(parse(text=input$bound_up_cf))
  }
  
  # down:
  if (input$selec1_down == "zg") {
    reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$down <- NULL
  }
  else if (input$selec2_down == "v") {
    reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$down <- as.numeric(input$bound_down_v)
  }
  else if (input$selec2_down == "ac") {
    datapath <- input$bound_down_ac$datapath
    reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$down <- handlers$annual_cycle(csv.file = datapath)
  }
  else if (input$selec2_down == "cf") {
    reac_vals$boundary_conditions[[reac_vals$boundary_to_modify]]$down <- eval(parse(text=input$bound_down_cf))
  }
  
  # update boundary_conditions list and close dialog
  boundary_conditions <<- reac_vals$boundary_conditions
  removeModal()
})
```

## Run Model
```{r steady_state, echo=FALSE}
actionButton("steady_state", "solve steady state")

observeEvent(input$steady_state, {
 withProgress(message = 'Solving model ...', min=0, max=0, {
    model_lists <<- handlers$create_model_lists()
    reac_vals$model_lists <- model_lists
    zz <- textConnection("ss_prints", "w")
    sink(zz)
    sink(zz, type="message")
    <<steady_state_solving>>
    sink(type="message")
    sink()
    close(zz)
    if (length(ss_prints) == 0) {
      reac_vals$ss <- ss
      reac_vals$show_ss_plots <- 1
    } else {
      reac_vals$ss_prints <- ss_prints
      reac_vals$show_ss_plots <- 2
    }
 })
})

# model output plots / error messages
reac_vals$show_ss_plots <- 0 # 0 -> model not solved yet -> nothing to display

ss_conc_selection <- reactive(stringr::str_split(input$ss_plot_collective_cp, ", ", simplify = TRUE))
ss_concentration_profiles_selec <- reactive(handlers$concentration_profiles_ss(ss_data=reac_vals$ss, draw_mode = "collective", species = ss_conc_selection(), v_correction=input$v_correction))
ss_concentration_profiles <- reactive(handlers$concentration_profiles_ss(ss_data=reac_vals$ss, v_correction=input$v_correction))

ss_rate_selection <- reactive(stringr::str_split(input$ss_plot_collective_rr, ", ", simplify = TRUE))
ss_rate_profiles_selec <- reactive(handlers$rate_profiles_ss(ss_data=reac_vals$ss, draw_mode = "collective", rates = ss_rate_selection()))
ss_rate_profiles <- reactive(handlers$rate_profiles_ss(ss_data=reac_vals$ss))

renderUI(
if (reac_vals$show_ss_plots == 1) {
  tabsetPanel(
    tabPanel(title="concentration profiles",
      div(
        br(),
        checkboxInput("v_correction", "correction for volume phases", value=TRUE),
        textInput("ss_plot_collective_cp", label="Enter species names to be plotted together", value = "OrgCA, OrgCB, OrgCC", width = "100%"),
        renderPlotly(ggplotly(ss_concentration_profiles_selec() + theme(legend.text = element_text(size = 11), legend.key.size = unit(0.8, "cm"))+ scale_color_discrete(name = NULL))),
        br(),
        renderPlot(ss_concentration_profiles(), height = function() {225*ceiling(length(attributes(reac_vals$ss$y)$dimnames[[2]])/4)}),
        style="overflow-y:scroll; max-height: 950px")
    ),
    tabPanel(title="reaction rate profiles",
      div(
        br(),
        textInput("ss_plot_collective_rr", label="Enter rate names to be plotted together", value = "R1_a, RN_a, RM_aa, R2_Ox_aa, R3_a, R4_a", width = "100%"),
        renderPlotly(ggplotly(ss_rate_profiles_selec() + theme(legend.text = element_text(size = 11), legend.key.size = unit(0.8, "cm")) + scale_color_discrete(name = NULL))),
        br(),
        renderPlot(ss_rate_profiles(), height = function() {225*ceiling(length(reac_vals$ss$reaction_rates)/4)}),
        style="overflow-y:scroll; max-height: 950px")
    ),
    tabPanel(title="combined profiles",
      div(
        br(),
        lapply(names(reac_vals$model_lists$species_operational), function(x) renderPlotly(ggplotly(handlers$combined_profiles_ss(ss_data=reac_vals$ss, species=x)))),
        style="overflow-y:scroll; max-height: 950px")
    ),
    tabPanel(title="model function content",
        div(
          renderPrint(cat(reac_vals$model_lists$t_combined_expression)),
          style="overflow-y:scroll; max-height: 950px;")
    )
  )
} else if (reac_vals$show_ss_plots == 2) {
  renderPrint(cat(reac_vals$ss_prints, sep = "\n"))
})
```


```{r on_exit, include=FALSE}
onStop(function () {
  file.remove("parameters_config_temp.R")
  file.remove("chemical_base_config_temp.R")
  file.remove("boundary_conditions_config_temp.R")
  })
```